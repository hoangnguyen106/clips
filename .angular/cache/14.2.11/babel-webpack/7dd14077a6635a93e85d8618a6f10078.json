{"ast":null,"code":"import _asyncToGenerator from \"C:/Users/nguye/Documents/GitHub/clips/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport { FormControl, FormGroup, Validators } from '@angular/forms';\nimport { switchMap } from 'rxjs/operators';\nimport { v4 as uuid } from 'uuid';\nimport firebase from 'firebase/compat/app';\nimport { combineLatest, forkJoin } from 'rxjs';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@angular/fire/compat/storage\";\nimport * as i2 from \"@angular/fire/compat/auth\";\nimport * as i3 from \"src/app/services/clip.service\";\nimport * as i4 from \"@angular/router\";\nimport * as i5 from \"src/app/services/ffmpeg.service\";\nimport * as i6 from \"@angular/common\";\nimport * as i7 from \"../../shared/input/input.component\";\nimport * as i8 from \"../../shared/alert/alert.component\";\nimport * as i9 from \"../../shared/directives/event-blocker.directive\";\nimport * as i10 from \"@angular/forms\";\nimport * as i11 from \"../pipes/safe-url.pipe\";\n\nfunction UploadComponent_span_5_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"span\", 5);\n    i0.ɵɵtext(1, \" settings \");\n    i0.ɵɵelementEnd();\n  }\n}\n\nfunction UploadComponent_ng_template_6_ng_container_0_span_4_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"span\", 5);\n    i0.ɵɵtext(1, \" autorenew \");\n    i0.ɵɵelementEnd();\n  }\n}\n\nconst _c0 = function (a0) {\n  return {\n    \"bg-indigo-400 border-indigo-400 border-solid\": a0\n  };\n};\n\nfunction UploadComponent_ng_template_6_ng_container_0_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r8 = i0.ɵɵgetCurrentView();\n\n    i0.ɵɵelementContainerStart(0);\n    i0.ɵɵelementStart(1, \"div\", 8);\n    i0.ɵɵlistener(\"dragend\", function UploadComponent_ng_template_6_ng_container_0_Template_div_dragend_1_listener() {\n      i0.ɵɵrestoreView(_r8);\n      const ctx_r7 = i0.ɵɵnextContext(2);\n      return i0.ɵɵresetView(ctx_r7.isDragover = false);\n    })(\"dragover\", function UploadComponent_ng_template_6_ng_container_0_Template_div_dragover_1_listener() {\n      i0.ɵɵrestoreView(_r8);\n      const ctx_r9 = i0.ɵɵnextContext(2);\n      return i0.ɵɵresetView(ctx_r9.isDragover = true);\n    })(\"dragenter\", function UploadComponent_ng_template_6_ng_container_0_Template_div_dragenter_1_listener() {\n      i0.ɵɵrestoreView(_r8);\n      const ctx_r10 = i0.ɵɵnextContext(2);\n      return i0.ɵɵresetView(ctx_r10.isDragover = true);\n    })(\"dragleave\", function UploadComponent_ng_template_6_ng_container_0_Template_div_dragleave_1_listener() {\n      i0.ɵɵrestoreView(_r8);\n      const ctx_r11 = i0.ɵɵnextContext(2);\n      return i0.ɵɵresetView(ctx_r11.isDragover = false);\n    })(\"mouseleave\", function UploadComponent_ng_template_6_ng_container_0_Template_div_mouseleave_1_listener() {\n      i0.ɵɵrestoreView(_r8);\n      const ctx_r12 = i0.ɵɵnextContext(2);\n      return i0.ɵɵresetView(ctx_r12.isDragover = false);\n    })(\"drop\", function UploadComponent_ng_template_6_ng_container_0_Template_div_drop_1_listener($event) {\n      i0.ɵɵrestoreView(_r8);\n      const ctx_r13 = i0.ɵɵnextContext(2);\n      return i0.ɵɵresetView(ctx_r13.storeFile($event));\n    });\n    i0.ɵɵelementStart(2, \"h5\");\n    i0.ɵɵtext(3, \"Drop your file here (mp4 only!)\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtemplate(4, UploadComponent_ng_template_6_ng_container_0_span_4_Template, 2, 0, \"span\", 9);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(5, \"input\", 10);\n    i0.ɵɵlistener(\"change\", function UploadComponent_ng_template_6_ng_container_0_Template_input_change_5_listener($event) {\n      i0.ɵɵrestoreView(_r8);\n      const ctx_r14 = i0.ɵɵnextContext(2);\n      return i0.ɵɵresetView(ctx_r14.storeFile($event));\n    });\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementContainerEnd();\n  }\n\n  if (rf & 2) {\n    const ctx_r3 = i0.ɵɵnextContext(2);\n    i0.ɵɵadvance(1);\n    i0.ɵɵproperty(\"ngClass\", i0.ɵɵpureFunction1(2, _c0, ctx_r3.isDragover));\n    i0.ɵɵadvance(3);\n    i0.ɵɵproperty(\"ngIf\", ctx_r3.ffmpegService.isRunning);\n  }\n}\n\nfunction UploadComponent_ng_template_6_ng_template_1_app_alert_0_p_3_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"p\");\n    i0.ɵɵtext(1);\n    i0.ɵɵpipe(2, \"percent\");\n    i0.ɵɵelementEnd();\n  }\n\n  if (rf & 2) {\n    const ctx_r17 = i0.ɵɵnextContext(4);\n    i0.ɵɵadvance(1);\n    i0.ɵɵtextInterpolate(i0.ɵɵpipeBind1(2, 1, ctx_r17.percentage));\n  }\n}\n\nfunction UploadComponent_ng_template_6_ng_template_1_app_alert_0_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"app-alert\", 21)(1, \"p\");\n    i0.ɵɵtext(2);\n    i0.ɵɵelementEnd();\n    i0.ɵɵtemplate(3, UploadComponent_ng_template_6_ng_template_1_app_alert_0_p_3_Template, 3, 3, \"p\", 22);\n    i0.ɵɵelementEnd();\n  }\n\n  if (rf & 2) {\n    const ctx_r15 = i0.ɵɵnextContext(3);\n    i0.ɵɵproperty(\"color\", ctx_r15.alertColor);\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate(ctx_r15.alertMsg);\n    i0.ɵɵadvance(1);\n    i0.ɵɵproperty(\"ngIf\", ctx_r15.showPercentage);\n  }\n}\n\nconst _c1 = function (a0, a1) {\n  return {\n    \"border-green-400\": a0,\n    \"border-transparent\": a1\n  };\n};\n\nfunction UploadComponent_ng_template_6_ng_template_1_div_5_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r20 = i0.ɵɵgetCurrentView();\n\n    i0.ɵɵelementStart(0, \"div\", 23);\n    i0.ɵɵlistener(\"click\", function UploadComponent_ng_template_6_ng_template_1_div_5_Template_div_click_0_listener() {\n      const restoredCtx = i0.ɵɵrestoreView(_r20);\n      const screenshot_r18 = restoredCtx.$implicit;\n      const ctx_r19 = i0.ɵɵnextContext(3);\n      return i0.ɵɵresetView(ctx_r19.selectedScreenshot = screenshot_r18);\n    });\n    i0.ɵɵelement(1, \"img\", 24);\n    i0.ɵɵpipe(2, \"safeURL\");\n    i0.ɵɵelementEnd();\n  }\n\n  if (rf & 2) {\n    const screenshot_r18 = ctx.$implicit;\n    const ctx_r16 = i0.ɵɵnextContext(3);\n    i0.ɵɵproperty(\"ngClass\", i0.ɵɵpureFunction2(4, _c1, screenshot_r18 === ctx_r16.selectedScreenshot, screenshot_r18 !== ctx_r16.selectedScreenshot));\n    i0.ɵɵadvance(1);\n    i0.ɵɵproperty(\"src\", i0.ɵɵpipeBind1(2, 2, screenshot_r18), i0.ɵɵsanitizeUrl);\n  }\n}\n\nconst _c2 = function (a0, a1) {\n  return {\n    \"opacity-50\": a0,\n    \"hover:bg-indigo-700\": a1\n  };\n};\n\nfunction UploadComponent_ng_template_6_ng_template_1_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r22 = i0.ɵɵgetCurrentView();\n\n    i0.ɵɵtemplate(0, UploadComponent_ng_template_6_ng_template_1_app_alert_0_Template, 4, 3, \"app-alert\", 11);\n    i0.ɵɵelementStart(1, \"form\", 12);\n    i0.ɵɵlistener(\"ngSubmit\", function UploadComponent_ng_template_6_ng_template_1_Template_form_ngSubmit_1_listener() {\n      i0.ɵɵrestoreView(_r22);\n      const ctx_r21 = i0.ɵɵnextContext(2);\n      return i0.ɵɵresetView(ctx_r21.uploadFile());\n    });\n    i0.ɵɵelementStart(2, \"h2\", 13);\n    i0.ɵɵtext(3, \"Select a Thumbnail\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(4, \"div\", 14);\n    i0.ɵɵtemplate(5, UploadComponent_ng_template_6_ng_template_1_div_5_Template, 3, 7, \"div\", 15);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(6, \"div\", 16)(7, \"label\", 17);\n    i0.ɵɵtext(8, \"Title\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelement(9, \"app-input\", 18);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(10, \"div\", 19)(11, \"button\", 20);\n    i0.ɵɵtext(12, \" Publish \");\n    i0.ɵɵelementEnd()()();\n  }\n\n  if (rf & 2) {\n    const ctx_r5 = i0.ɵɵnextContext(2);\n    i0.ɵɵproperty(\"ngIf\", ctx_r5.showAlert);\n    i0.ɵɵadvance(1);\n    i0.ɵɵproperty(\"formGroup\", ctx_r5.uploadForm);\n    i0.ɵɵadvance(4);\n    i0.ɵɵproperty(\"ngForOf\", ctx_r5.screenshots);\n    i0.ɵɵadvance(4);\n    i0.ɵɵproperty(\"control\", ctx_r5.title);\n    i0.ɵɵadvance(2);\n    i0.ɵɵproperty(\"disabled\", ctx_r5.isSubmission)(\"ngClass\", i0.ɵɵpureFunction2(6, _c2, ctx_r5.isSubmission, !ctx_r5.isSubmission));\n  }\n}\n\nfunction UploadComponent_ng_template_6_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵtemplate(0, UploadComponent_ng_template_6_ng_container_0_Template, 6, 4, \"ng-container\", 6);\n    i0.ɵɵtemplate(1, UploadComponent_ng_template_6_ng_template_1_Template, 13, 9, \"ng-template\", null, 7, i0.ɵɵtemplateRefExtractor);\n  }\n\n  if (rf & 2) {\n    const _r4 = i0.ɵɵreference(2);\n\n    const ctx_r2 = i0.ɵɵnextContext();\n    i0.ɵɵproperty(\"ngIf\", !ctx_r2.nextStep)(\"ngIfElse\", _r4);\n  }\n}\n\nexport class UploadComponent {\n  constructor(storage, auth, clipsService, router, ffmpegService) {\n    this.storage = storage;\n    this.auth = auth;\n    this.clipsService = clipsService;\n    this.router = router;\n    this.ffmpegService = ffmpegService;\n    this.isDragover = false;\n    this.file = null;\n    this.nextStep = false;\n    this.showAlert = false;\n    this.alertColor = 'blue';\n    this.alertMsg = 'Please wait! Your clip is being uploaded.';\n    this.isSubmission = false;\n    this.percentage = 0;\n    this.showPercentage = false;\n    this.user = null;\n    this.screenshots = [];\n    this.selectedScreenshot = '';\n    this.title = new FormControl('', [Validators.required, Validators.minLength(3)] // nonNullable: true\n    );\n    this.uploadForm = new FormGroup({\n      title: this.title\n    });\n    auth.user.subscribe(user => this.user = user);\n    this.ffmpegService.init();\n  }\n\n  ngOnInit() {}\n\n  ngOnDestroy() {\n    var _a;\n\n    (_a = this.task) === null || _a === void 0 ? void 0 : _a.cancel();\n  }\n\n  storeFile($event) {\n    var _this = this;\n\n    return _asyncToGenerator(function* () {\n      var _a, _b, _c, _d; //check xem ffmpeg có running hay không\n\n\n      if (_this.ffmpegService.isRunning) {\n        return;\n      }\n\n      _this.isDragover = false;\n      _this.file = $event.dataTransfer ? (_b = (_a = $event.dataTransfer) === null || _a === void 0 ? void 0 : _a.files.item(0)) !== null && _b !== void 0 ? _b : null : (_d = (_c = $event.target.files) === null || _c === void 0 ? void 0 : _c.item(0)) !== null && _d !== void 0 ? _d : null;\n\n      if (!_this.file || _this.file.type != 'video/mp4') {\n        return;\n      }\n\n      _this.screenshots = yield _this.ffmpegService.getScreenshots(_this.file); //active screenshot\n\n      _this.selectedScreenshot = _this.screenshots[0];\n\n      _this.title.setValue(_this.file.name.replace(/\\.[^/.]+$/, ''));\n\n      _this.nextStep = true;\n      console.log(_this.file);\n    })();\n  }\n\n  uploadFile() {\n    var _this2 = this;\n\n    return _asyncToGenerator(function* () {\n      _this2.uploadForm.disable();\n\n      _this2.showAlert = true;\n      _this2.alertColor = 'blue';\n      _this2.alertMsg = 'Please wait! Your clip is being uploaded.';\n      _this2.isSubmission = true;\n      _this2.showPercentage = true;\n      const clipFileName = uuid();\n      const clipPath = `clips/${clipFileName}.mp4`;\n      const screenshotBlob = yield _this2.ffmpegService.blobFromURL(_this2.selectedScreenshot);\n      const screenshotPath = `screenshots/${clipFileName}.png`;\n      _this2.task = _this2.storage.upload(clipPath, _this2.file);\n\n      const clipRef = _this2.storage.ref(clipPath);\n\n      _this2.screenshotTask = _this2.storage.upload(screenshotPath, screenshotBlob);\n\n      const screenshotRef = _this2.storage.ref(screenshotPath);\n\n      combineLatest([_this2.task.percentageChanges(), _this2.screenshotTask.percentageChanges()]).subscribe(progress => {\n        const [clipProgress, screenshotProgress] = progress;\n\n        if (!clipProgress || !screenshotProgress) {\n          return;\n        }\n\n        const total = clipProgress + screenshotProgress;\n        _this2.percentage = total / 200;\n      });\n      forkJoin([_this2.task.snapshotChanges(), _this2.screenshotTask.snapshotChanges()]).pipe(switchMap(() => forkJoin([clipRef.getDownloadURL(), screenshotRef.getDownloadURL()]))).subscribe({\n        next: function () {\n          var _ref = _asyncToGenerator(function* (urls) {\n            var _a, _b;\n\n            const [clipURL, screenshotURL] = urls;\n            const clip = {\n              uid: (_a = _this2.user) === null || _a === void 0 ? void 0 : _a.uid,\n              displayName: (_b = _this2.user) === null || _b === void 0 ? void 0 : _b.displayName,\n              title: _this2.title.value,\n              fileName: `${clipFileName}.mp4`,\n              url: clipURL,\n              screenshotURL,\n              screenshotFileName: `${clipFileName}.png`,\n              timestamp: firebase.firestore.FieldValue.serverTimestamp()\n            };\n            const clipDocRef = yield _this2.clipsService.createClip(clip);\n            console.log(clip);\n            _this2.alertColor = 'green';\n            _this2.alertMsg = 'Suceess! Your clip us now ready to share with the world.';\n            _this2.showPercentage = false;\n            setTimeout(() => {\n              _this2.router.navigate(['clip', clipDocRef.id]);\n            }, 1000);\n          });\n\n          return function next(_x) {\n            return _ref.apply(this, arguments);\n          };\n        }(),\n        error: error => {\n          _this2.uploadForm.enable();\n\n          _this2.alertColor = 'red';\n          _this2.alertMsg = 'Upload failed! Please try again later';\n          _this2.isSubmission = true;\n          _this2.showPercentage = false;\n          console.error(error);\n        }\n      });\n    })();\n  }\n\n}\n\nUploadComponent.ɵfac = function UploadComponent_Factory(t) {\n  return new (t || UploadComponent)(i0.ɵɵdirectiveInject(i1.AngularFireStorage), i0.ɵɵdirectiveInject(i2.AngularFireAuth), i0.ɵɵdirectiveInject(i3.ClipService), i0.ɵɵdirectiveInject(i4.Router), i0.ɵɵdirectiveInject(i5.FfmpegService));\n};\n\nUploadComponent.ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n  type: UploadComponent,\n  selectors: [[\"app-upload\"]],\n  decls: 8,\n  vars: 2,\n  consts: [[1, \"container\", \"mx-auto\", \"my-8\", \"bg-secondary\", \"p-6\"], [1, \"rounded\", \"relative\", \"flex\", \"flex-col\"], [1, \"font-bold\", \"mb-6\"], [\"class\", \"material-icons text-center text-6xl p-8 animate-spin\", 4, \"ngIf\", \"ngIfElse\"], [\"uploadEditorCtr\", \"\"], [1, \"material-icons\", \"text-center\", \"text-6xl\", \"p-8\", \"animate-spin\"], [4, \"ngIf\", \"ngIfElse\"], [\"uploadFormCtr\", \"\"], [\"app-event-blocker\", \"\", 1, \"w-full\", \"px-10\", \"py-40\", \"rounded\", \"text-center\", \"cursor-pointer\", \"border\", \"border-dashed\", \"border-gray-400\", \"transition\", \"duration-500\", \"hover:text-white\", \"hover:bg-indigo-400\", \"hover:border-indigo-400\", \"hover:border-solid\", \"text-xl\", 3, \"ngClass\", \"dragend\", \"dragover\", \"dragenter\", \"dragleave\", \"mouseleave\", \"drop\"], [\"class\", \"material-icons text-center text-6xl p-8 animate-spin\", 4, \"ngIf\"], [\"type\", \"file\", 1, \"mt-4\", 3, \"change\"], [3, \"color\", 4, \"ngIf\"], [3, \"formGroup\", \"ngSubmit\"], [1, \"mb-4\", \"text-xl\"], [1, \"grid\", \"grid-cols-1\", \"lg:grid-cols-3\", \"gap-4\"], [\"class\", \"border-8 cursor-pointer\", 3, \"ngClass\", \"click\", 4, \"ngFor\", \"ngForOf\"], [1, \"mt-4\"], [1, \"block\", \"text-xl\", \"mb-4\"], [\"placeholder\", \"Enter Title\", 3, \"control\"], [1, \"mt-4\", \"text-right\"], [\"type\", \"submit\", 1, \"inline-flex\", \"justify-center\", \"py-2\", \"px-4\", \"border\", \"border-transparent\", \"shadow-sm\", \"rounded-md\", \"text-white\", \"bg-indigo-600\", \"focus:outline-none\", 3, \"disabled\", \"ngClass\"], [3, \"color\"], [4, \"ngIf\"], [1, \"border-8\", \"cursor-pointer\", 3, \"ngClass\", \"click\"], [3, \"src\"]],\n  template: function UploadComponent_Template(rf, ctx) {\n    if (rf & 1) {\n      i0.ɵɵelementStart(0, \"section\", 0)(1, \"div\", 1)(2, \"div\", 2);\n      i0.ɵɵtext(3, \"Upload Video\");\n      i0.ɵɵelementEnd();\n      i0.ɵɵelementContainerStart(4);\n      i0.ɵɵtemplate(5, UploadComponent_span_5_Template, 2, 0, \"span\", 3);\n      i0.ɵɵelementContainerEnd();\n      i0.ɵɵtemplate(6, UploadComponent_ng_template_6_Template, 3, 2, \"ng-template\", null, 4, i0.ɵɵtemplateRefExtractor);\n      i0.ɵɵelementEnd()();\n    }\n\n    if (rf & 2) {\n      const _r1 = i0.ɵɵreference(7);\n\n      i0.ɵɵadvance(5);\n      i0.ɵɵproperty(\"ngIf\", !ctx.ffmpegService.isReady)(\"ngIfElse\", _r1);\n    }\n  },\n  dependencies: [i6.NgClass, i6.NgForOf, i6.NgIf, i7.InputComponent, i8.AlertComponent, i9.EventBlockerDirective, i10.ɵNgNoValidate, i10.NgControlStatusGroup, i10.FormGroupDirective, i6.PercentPipe, i11.SafeURLPipe],\n  styles: [\"\\n/*# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IiIsImZpbGUiOiJ1cGxvYWQuY29tcG9uZW50LmNzcyJ9 */\"]\n});","map":{"version":3,"mappings":"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","names":["FormControl","FormGroup","Validators","switchMap","v4","uuid","firebase","combineLatest","forkJoin","i0","_r4","UploadComponent","constructor","storage","auth","clipsService","router","ffmpegService","required","minLength","title","user","subscribe","init","ngOnInit","ngOnDestroy","task","_a","cancel","storeFile","$event","isRunning","isDragover","file","dataTransfer","files","item","_b","target","_c","_d","type","screenshots","getScreenshots","selectedScreenshot","setValue","name","replace","nextStep","console","log","uploadFile","uploadForm","disable","showAlert","alertColor","alertMsg","isSubmission","showPercentage","clipFileName","clipPath","screenshotBlob","blobFromURL","screenshotPath","upload","clipRef","ref","screenshotTask","screenshotRef","percentageChanges","progress","clipProgress","screenshotProgress","total","percentage","snapshotChanges","pipe","getDownloadURL","next","urls","clipURL","screenshotURL","clip","uid","displayName","value","fileName","url","screenshotFileName","timestamp","firestore","FieldValue","serverTimestamp","clipDocRef","createClip","setTimeout","navigate","id","error","enable","selectors","decls","vars","consts","template","_r1"],"sourceRoot":"","sources":["C:\\Users\\nguye\\Documents\\GitHub\\clips\\src\\app\\video\\upload\\upload.component.ts","C:\\Users\\nguye\\Documents\\GitHub\\clips\\src\\app\\video\\upload\\upload.component.html"],"sourcesContent":["import { Component, OnDestroy, OnInit } from '@angular/core';\r\nimport { AngularFireAuth } from '@angular/fire/compat/auth';\r\nimport {\r\n  AngularFireStorage,\r\n  AngularFireUploadTask,\r\n} from '@angular/fire/compat/storage';\r\nimport { FormControl, FormGroup, Validators } from '@angular/forms';\r\nimport { last, switchMap } from 'rxjs/operators';\r\nimport { v4 as uuid } from 'uuid';\r\nimport firebase from 'firebase/compat/app';\r\nimport { ClipService } from 'src/app/services/clip.service';\r\nimport { async } from '@angular/core/testing';\r\nimport { Router } from '@angular/router';\r\nimport { FfmpegService } from 'src/app/services/ffmpeg.service';\r\nimport { combineLatest, forkJoin } from 'rxjs';\r\n\r\n@Component({\r\n  selector: 'app-upload',\r\n  templateUrl: './upload.component.html',\r\n  styleUrls: ['./upload.component.css'],\r\n})\r\nexport class UploadComponent implements OnInit, OnDestroy {\r\n  isDragover = false;\r\n  file: File | null = null;\r\n  nextStep = false;\r\n  showAlert = false;\r\n  alertColor = 'blue';\r\n  alertMsg = 'Please wait! Your clip is being uploaded.';\r\n  isSubmission = false;\r\n  percentage = 0;\r\n  showPercentage = false;\r\n  user: firebase.User | null = null;\r\n  task?: AngularFireUploadTask;\r\n  screenshots: string[] = [];\r\n  selectedScreenshot = '';\r\n  screenshotTask?: AngularFireUploadTask;\r\n\r\n  title = new FormControl(\r\n    '',\r\n    [Validators.required, Validators.minLength(3)]\r\n    // nonNullable: true\r\n  );\r\n\r\n  uploadForm = new FormGroup({\r\n    title: this.title,\r\n  });\r\n\r\n  constructor(\r\n    private storage: AngularFireStorage,\r\n    private auth: AngularFireAuth,\r\n    private clipsService: ClipService,\r\n    private router: Router,\r\n    public ffmpegService: FfmpegService\r\n  ) {\r\n    auth.user.subscribe((user) => (this.user = user));\r\n    this.ffmpegService.init();\r\n  }\r\n\r\n  ngOnInit(): void {}\r\n\r\n  ngOnDestroy(): void {\r\n    this.task?.cancel();\r\n  }\r\n\r\n  async storeFile($event: Event) {\r\n    //check xem ffmpeg có running hay không\r\n    if (this.ffmpegService.isRunning) {\r\n      return;\r\n    }\r\n\r\n    this.isDragover = false;\r\n\r\n    this.file = ($event as DragEvent).dataTransfer\r\n      ? ($event as DragEvent).dataTransfer?.files.item(0) ?? null\r\n      : ($event.target as HTMLInputElement).files?.item(0) ?? null;\r\n\r\n    if (!this.file || this.file.type != 'video/mp4') {\r\n      return;\r\n    }\r\n\r\n    this.screenshots = await this.ffmpegService.getScreenshots(this.file);\r\n    //active screenshot\r\n    this.selectedScreenshot = this.screenshots[0];\r\n\r\n    this.title.setValue(this.file.name.replace(/\\.[^/.]+$/, ''));\r\n    this.nextStep = true;\r\n\r\n    console.log(this.file);\r\n  }\r\n\r\n  async uploadFile() {\r\n    this.uploadForm.disable();\r\n    this.showAlert = true;\r\n    this.alertColor = 'blue';\r\n    this.alertMsg = 'Please wait! Your clip is being uploaded.';\r\n    this.isSubmission = true;\r\n    this.showPercentage = true;\r\n\r\n    const clipFileName = uuid();\r\n    const clipPath = `clips/${clipFileName}.mp4`;\r\n\r\n    const screenshotBlob = await this.ffmpegService.blobFromURL(\r\n      this.selectedScreenshot\r\n    );\r\n\r\n    const screenshotPath = `screenshots/${clipFileName}.png`;\r\n\r\n    this.task = this.storage.upload(clipPath, this.file);\r\n    const clipRef = this.storage.ref(clipPath);\r\n\r\n    this.screenshotTask = this.storage.upload(screenshotPath, screenshotBlob);\r\n    const screenshotRef = this.storage.ref(screenshotPath);\r\n\r\n    combineLatest([\r\n      this.task.percentageChanges(),\r\n      this.screenshotTask.percentageChanges(),\r\n    ]).subscribe((progress) => {\r\n      const [clipProgress, screenshotProgress] = progress;\r\n\r\n      if (!clipProgress || !screenshotProgress) {\r\n        return;\r\n      }\r\n      const total = clipProgress + screenshotProgress;\r\n      this.percentage = (total as number) / 200;\r\n    });\r\n\r\n    forkJoin([\r\n      this.task.snapshotChanges(),\r\n      this.screenshotTask.snapshotChanges(),\r\n    ])\r\n      .pipe(\r\n        switchMap(() =>\r\n          forkJoin([clipRef.getDownloadURL(), screenshotRef.getDownloadURL()])\r\n        )\r\n      )\r\n      .subscribe({\r\n        next: async (urls) => {\r\n          const [clipURL, screenshotURL] = urls\r\n          const clip = {\r\n            uid: this.user?.uid as string,\r\n            displayName: this.user?.displayName as string,\r\n            title: this.title.value,\r\n            fileName: `${clipFileName}.mp4`,\r\n            url: clipURL,\r\n            screenshotURL,\r\n            screenshotFileName: `${clipFileName}.png`,\r\n            timestamp: firebase.firestore.FieldValue.serverTimestamp(),\r\n          };\r\n\r\n          const clipDocRef = await this.clipsService.createClip(clip);\r\n\r\n          console.log(clip);\r\n          this.alertColor = 'green';\r\n          this.alertMsg =\r\n            'Suceess! Your clip us now ready to share with the world.';\r\n          this.showPercentage = false;\r\n\r\n          setTimeout(() => {\r\n            this.router.navigate(['clip', clipDocRef.id]);\r\n          }, 1000);\r\n        },\r\n        error: (error) => {\r\n          this.uploadForm.enable();\r\n          this.alertColor = 'red';\r\n          this.alertMsg = 'Upload failed! Please try again later';\r\n          this.isSubmission = true;\r\n          this.showPercentage = false;\r\n          console.error(error);\r\n        },\r\n      });\r\n  }\r\n}\r\n","<!-- Main Content -->\r\n<section class=\"container mx-auto my-8 bg-secondary p-6\">\r\n  <div class=\"rounded relative flex flex-col\">\r\n    <div class=\"font-bold mb-6\">Upload Video</div>\r\n\r\n    <ng-container>\r\n      <span\r\n        *ngIf=\"!ffmpegService.isReady; else uploadEditorCtr\"\r\n        class=\"material-icons text-center text-6xl p-8 animate-spin\"\r\n      >\r\n        settings\r\n      </span>\r\n    </ng-container>\r\n\r\n    <ng-template #uploadEditorCtr>\r\n      <!-- Upload Dropbox -->\r\n      <ng-container *ngIf=\"!nextStep; else uploadFormCtr\">\r\n        <div\r\n          app-event-blocker\r\n          (dragend)=\"isDragover = false\"\r\n          (dragover)=\"isDragover = true\"\r\n          (dragenter)=\"isDragover = true\"\r\n          (dragleave)=\"isDragover = false\"\r\n          (mouseleave)=\"isDragover = false\"\r\n          (drop)=\"storeFile($event)\"\r\n          [ngClass]=\"{\r\n            'bg-indigo-400 border-indigo-400 border-solid': isDragover\r\n          }\"\r\n          class=\"w-full px-10 py-40 rounded text-center cursor-pointer border border-dashed border-gray-400 transition duration-500 hover:text-white hover:bg-indigo-400 hover:border-indigo-400 hover:border-solid text-xl\"\r\n        >\r\n          <h5>Drop your file here (mp4 only!)</h5>\r\n          <span\r\n            *ngIf=\"ffmpegService.isRunning\"\r\n            class=\"material-icons text-center text-6xl p-8 animate-spin\"\r\n          >\r\n            autorenew\r\n          </span>\r\n        </div>\r\n        <input type=\"file\" class=\"mt-4\" (change)=\"storeFile($event)\" />\r\n      </ng-container>\r\n\r\n      <!-- Video Editor -->\r\n      <ng-template #uploadFormCtr>\r\n        <app-alert *ngIf=\"showAlert\" [color]=\"alertColor\">\r\n          <p>{{ alertMsg }}</p>\r\n          <p *ngIf=\"showPercentage\">{{ percentage | percent }}</p>\r\n        </app-alert>\r\n\r\n        <!-- Form -->\r\n        <form [formGroup]=\"uploadForm\" (ngSubmit)=\"uploadFile()\">\r\n          <!-- Screenshots -->\r\n          <h2 class=\"mb-4 text-xl\">Select a Thumbnail</h2>\r\n          <div class=\"grid grid-cols-1 lg:grid-cols-3 gap-4\">\r\n            <div\r\n              *ngFor=\"let screenshot of screenshots\"\r\n              [ngClass]=\"{\r\n                'border-green-400': screenshot === selectedScreenshot,\r\n                'border-transparent': screenshot !== selectedScreenshot\r\n              }\"\r\n              class=\"border-8 cursor-pointer\"\r\n              (click)=\"selectedScreenshot = screenshot\"\r\n            >\r\n              <img [src]=\"screenshot | safeURL\" />\r\n            </div>\r\n          </div>\r\n\r\n          <!-- Title -->\r\n          <div class=\"mt-4\">\r\n            <label class=\"block text-xl mb-4\">Title</label>\r\n            <app-input [control]=\"title\" placeholder=\"Enter Title\"></app-input>\r\n          </div>\r\n\r\n          <div class=\"mt-4 text-right\">\r\n            <button\r\n              [disabled]=\"isSubmission\"\r\n              [ngClass]=\"{\r\n                'opacity-50': isSubmission,\r\n                'hover:bg-indigo-700': !isSubmission\r\n              }\"\r\n              type=\"submit\"\r\n              class=\"inline-flex justify-center py-2 px-4 border border-transparent shadow-sm rounded-md text-white bg-indigo-600 focus:outline-none\"\r\n            >\r\n              Publish\r\n            </button>\r\n          </div>\r\n        </form>\r\n      </ng-template>\r\n    </ng-template>\r\n  </div>\r\n</section>\r\n"]},"metadata":{},"sourceType":"module"}